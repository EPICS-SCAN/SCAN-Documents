//Make sure to install the SD library in Arduino IDE's library manager

#include "SPI.h"
#include "SD.h"//http://librarymanager/All#SD
#include <Arduino.h>
#include "LoRaWan-Arduino.h"


//THE PROGRAM WILL PRINT THE DETECTED OBJECT DISTANCE IN CM TO THE SERIAL PORT
const byte trigPin = WB_IO1; //Pin numberof sensor trigger pin (transmit)
const byte echoPin = WB_IO2; //Pin number of sensor echo pin (receiver)

//CONSTANTS
#define CM_PER_MICROSECOND .0343 //Speed of sound in cm per microsecond
#define TRIP_DISTANCE 400 //Distance to trip sensor in cm
#define UNDEFINED_DISTANCE 1000
#define FILE_NAME "RAK_DATA.txt"
#define DATA_STRING_LENGTH 15
#define DATA_ARRAY_SIZE 100
//Variables

int counter = 0;
int array_index = 0;
long duration; //Time between ultrasound trasmit and receive
int distance; //Distance from sensor to object
int distances[10];
char data_string[DATA_STRING_LENGTH] = "";
char data_array[DATA_ARRAY_SIZE][DATA_STRING_LENGTH];

//NEW
int idle = 0;
int low = 1;
int send = 2;
int car_count = 0;
int state = 0;

// LoRaWAN send interval (ms)
#define LORAWAN_APP_DATA_BUFF_SIZE 64
#define JOINREQ_NBTRIALS 8
bool doOTAA = true;

// ---------- Device Credentials (fill from ChirpStack) ----------
uint8_t nodeDeviceEUI[8] = {0xAC, 0x1F, 0x09, 0xFF, 0xFE, 0x05, 0x10, 0x95};
uint8_t nodeAppEUI[8]    = {0xAC, 0x1F, 0x09, 0xFF, 0xFE, 0x05, 0x10, 0x95};
uint8_t nodeAppKey[16]   = {0x89, 0x4C, 0xD5, 0xB2, 0x3D, 0x7A, 0x1D, 0xF1, 0x6B, 0x4F, 0xED, 0x2F, 0x10, 0x3F, 0xDF, 0xE5};

// ---------- Region and LoRa Config ----------
DeviceClass_t g_CurrentClass = CLASS_A;
LoRaMacRegion_t g_CurrentRegion = LORAMAC_REGION_US915; // Change for your location
lmh_confirm g_CurrentConfirm = LMH_UNCONFIRMED_MSG;
uint8_t gAppPort = 2; // Application port

// Parameters
static lmh_param_t g_lora_param_init = {
  LORAWAN_ADR_ON,
  LORAWAN_DEFAULT_DATARATE,
  LORAWAN_PUBLIC_NETWORK,
  JOINREQ_NBTRIALS,
  LORAWAN_DEFAULT_TX_POWER,
  LORAWAN_DUTYCYCLE_OFF
};

// ---------- Callback Declarations ----------
void lorawan_has_joined_handler(void);
void lorawan_join_failed_handler(void);
void lorawan_rx_handler(lmh_app_data_t *app_data);
void lorawan_confirm_class_handler(DeviceClass_t Class);
void send_lora_frame(void);
void tx_lora_periodic_handler(void);

// ---------- Callback Struct ----------
static lmh_callback_t g_lora_callbacks = {
  BoardGetBatteryLevel,
  BoardGetUniqueId,
  BoardGetRandomSeed,
  lorawan_rx_handler,
  lorawan_has_joined_handler,
  lorawan_confirm_class_handler,
  lorawan_join_failed_handler
};

// ---------- Buffers ----------
static uint8_t m_lora_app_data_buffer[LORAWAN_APP_DATA_BUFF_SIZE];
static lmh_app_data_t m_lora_app_data = { m_lora_app_data_buffer, 0, 0, 0, 0 };

bool send_now = false;

void setup() {
  Serial.begin(115200);
  delay(1000);

  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  distances[0] = 0;
  // Initialize LoRa hardware
  if (lora_rak11300_init() != 0) {
    Serial.println("‚ùå LoRa init failed!");
    while (1);
  }

  // Set OTAA credentials
  lmh_setDevEui(nodeDeviceEUI);
  lmh_setAppEui(nodeAppEUI);
  lmh_setAppKey(nodeAppKey);

    // Initialize LoRaWAN stack
  uint32_t err_code = lmh_init(&g_lora_callbacks, g_lora_param_init, doOTAA, g_CurrentClass, g_CurrentRegion);
  
  if (err_code != 0) {
  Serial.printf("lmh_init failed - %d\n", err_code);
  while (1);
  }

  // Select correct sub-band (for US915: 0‚Äì7)
  // Match this to your gateway‚Äôs sub-band (for LPS8 default is 2)
  if (!lmh_setSubBandChannels(6)) {
    Serial.println("‚ö†Ô∏è Sub-band setup failed. Check gateway configuration!");
  }

  // Start OTAA Join
  Serial.println("üöÄ Joining LoRaWAN network...");
  lmh_join();}

void loop() {
  if (send_now) {
    send_now = false;
    send_lora_frame();
  }

  
  delay(40);
  digitalWrite(trigPin, LOW);
  delayMicroseconds(10);
 
  //Send a 10 microsecond ultrasonic pulse
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  //Measure microseconds between pulse trasmission and reception
  duration = pulseIn(echoPin, HIGH);
 
  if(duration >= 29154){
    distance = UNDEFINED_DISTANCE;
  }
  else if (duration != 0) {
    //Calculate distance
    distance = (duration * CM_PER_MICROSECOND) / 2;
  }
  else {
    //Assume object is very far away
    distance = UNDEFINED_DISTANCE;
  }

  //Add distance to array
  if(distance == UNDEFINED_DISTANCE && counter != 0)
  {
    distances[counter] = distances[counter - 1];
  }
  else if(distance == UNDEFINED_DISTANCE)
  {
    distances[counter] = distances[9];
  }
  else{
    distances[counter] = distance;
  }

  if(counter == 9)
  {
    counter = 0;
  }
  else 
  {
    counter++;
  }

  // If distance turns out undefined, set distance value to last valid distance
  if(distance == UNDEFINED_DISTANCE && counter != 0)
  {
    distance = distances[counter - 1];
  }
  else if(distance == UNDEFINED_DISTANCE)
  {
    distance = distances[9];
  }
  else{
    distance = distance;
  }
  if (state == idle && distance < 50){
    state = low;
  }
  else if(state == low && distance > 100){
    state = send;
  }
  else if(state == send){
    car_count ++;
    state = idle;
    Serial.println(car_count);
    send_now = true;

  }

}

void lorawan_has_joined_handler(void) {
  Serial.println("‚úÖ LoRaWAN joined successfully!");
  appTimer.attach(tx_lora_periodic_handler, std::chrono::milliseconds(LORAWAN_APP_INTERVAL));
}

void lorawan_join_failed_handler(void) {
  Serial.println("‚ùå Join failed. Check EUIs, Keys, and Gateway coverage.");
}

void lorawan_rx_handler(lmh_app_data_t *app_data) {
  Serial.printf("üì© Received downlink on port %d, size: %d bytes\n", app_data->port, app_data->buffsize);
}

void lorawan_confirm_class_handler(DeviceClass_t Class) {
  Serial.printf("Switched to Class %c\n", "ABC"[Class]);
}

void send_lora_frame(void) {
  if (lmh_join_status_get() != LMH_SET) {
    Serial.println("‚ö†Ô∏è Not joined yet, skipping send");
    return;
  }
 char msg[5];
  sprintf(msg, "%04d", car_count);

 memcpy(m_lora_app_data.buffer, msg, 4);
  m_lora_app_data.buffsize = 4;
  m_lora_app_data.port = gAppPort;

  lmh_error_status result = lmh_send(&m_lora_app_data, g_CurrentConfirm);
  if (result == LMH_SUCCESS) {
    Serial.printf("üì§ Sent parking count: %s\n", msg);
  } else {
    Serial.printf("‚ùå Send failed with code %d\n", result);
  }
}
